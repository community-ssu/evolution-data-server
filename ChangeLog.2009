2009-05-06  Robert Peto  <robert.peto@maemo.org>

	Fix memory leak in file-backend.

	* addressbook/backends/file/e-book-backend-file.c
	(install_pre_installed_vcards()): Close GDir when escaping

2009-05-06  Robert Peto  <robert.peto@maemo.org>

	Convert date parameters to ISO 8601 basic format since some 2.1
	parsers can handle only this.

	* addressbook/libebook-dbus/e-vcard.c (e_vcard_to_string_vcard_21 ())

	Reviewed-By: Jonathon Jongsma  <jonathon.jongsma@maemo.org>

2009-05-06  Robert Peto  <robert.peto@maemo.org>

	NB#111407 - e-d-s crash in e_book_backend_file_load_source ()
	NB#111722 - Customized preinstalled contact is not shown in Contacts.

	* addressbook/backends/file/e-book-backend-file.c
	(e_book_backend_file_load_source()): assign addressbook's DB after it
	has been created successfully.

	Reviewed-By: Joergen Scheibengruber <jorgen.scheibengruber@nokia.com>

2009-04-29  Marco Barisione  <marco.barisione@maemo.org>

	reviewed by: Robert Peto

	* libebook-dbus/e-book.c (get_required_fields_reply),
	(get_supported_fields_reply), (get_supported_auth_methods_reply),
	(get_changes_reply), (add_contacts_reply), (get_book_view_reply):
	In case of error don't use the return values of D-Bus calls as they
	are uninitialised garbage.

2009-04-27  Robert Peto  <robert.peto@maemo.org>

	* addressbook/libebook-dbus/e-vcard.c (read_attribute_value(),
	read_attribute_params(), read_attribute()): Check CHARSET parameter
	and convert different charsets to UTF-8.

	* e_vcard_to_string_vcard_21(): Put CHARSET=UTF-8 string where
	QUOTED-PRINTABLE encoding is applied, since we represent all strings
	in UTF-8 internally.

2009-04-23  Robert Peto  <robert.peto@maemo.org>

	Pupulate back the removed ids after contacts are deleted in file-backend.

	* addressbook/backends/file/e-book-backend-file.c
	 (e_book_backend_file_remove_contacts())

2009-04-22  Robert Peto  <robert.peto@maemo.org>

	Sync both main db and index db when file-backend's sync method is
	called.

2009-04-21  Robert Peto  <robert.peto@maemo.org>

	* addressbook/libedata-book-dbus/e-book-backend.c
	(e_book_backend_start_book_view(), e_book_backend_stop_book_view()):
	Start/Stop book views only after backend is loaded.

2009-04-16  Jonathon Jongsma  <jonathon.jongsma@maemo.org>

	* addressbook/libebook-dbus/e-book.c:
	Take a ref on the EBook* or EBookQuery* variables when we use them for async
	dbus calls.  Only one of the functions in this file actually reffed the
	object that it was holding.  So I added some helper functions to
	automatically ref and unref these variables when creating / freeing the
	AsyncData structs.  Fixes: NB#108665

2009-04-16  Jonathon Jongsma  <jonathon.jongsma@maemo.org>

	* addressbook/libebook-dbus/e-vcard.c:
	un-revert a couple changes that should not have been reverted with the lazy parsing.

2009-04-16  Jonathon Jongsma  <jonathon.jongsma@maemo.org>

	* Revert lazy vcard parsing since it was causing too many regressions

2009-04-15  Jonathon Jongsma  <jonathon.jongsma@maemo.org>

	* addressbook/libedata-book-dbus/e-data-book-view.c:
	revert commit below freeing ptr array segment because it was causing crashes

2009-04-15  Robert Peto  <robert.peto@maemo.org>

	* addressbook/libebook-dbus/e-vcard.c (e_vcard_to_string_vcard_21):
	Insert an exra new line after every base64 encoded value.

2009-04-14  Jonathon Jongsma  <jonathon.jongsma@maemo.org>

	* addressbook/libedata-book-dbus/e-data-book-view.c:
	Fix leak by freeing the ptr array segment.  valgrind report:
		==27370== 896 bytes in 4 blocks are definitely lost in loss record 13 of 30
		==27370==    at 0x47E7C19: malloc (vg_replace_malloc.c:207)
		==27370==    by 0x47E7D5F: realloc (vg_replace_malloc.c:429)
		==27370==    by 0x718FB13: g_realloc (gmem.c:170)
		==27370==    by 0x7162C12: g_ptr_array_maybe_expand (garray.c:414)
		==27370==    by 0x71630C5: g_ptr_array_sized_new (garray.c:379)
		==27370==    by 0x47F9498: e_data_book_view_init (e-data-book-view.c:146)
		==27370==    by 0x4A9C28E: g_type_create_instance (gtype.c:1674)
		==27370==    by 0x4A80B90: g_object_constructor (gobject.c:1334)
		==27370==    by 0x4A7F5CD: g_object_newv (gobject.c:1211)
		==27370==    by 0x4A800CF: g_object_new_valist (gobject.c:1274)
		==27370==    by 0x4A80216: g_object_new (gobject.c:1056)
		==27370==    by 0x47F8F8F: e_data_book_view_new (e-data-book-view.c:229)

2009-04-14  Jonathon Jongsma  <jonathon.jongsma@maemo.org>

	* addressbook/libedata-book/e-book-backend-sync.c
	(_e_book_backend_create_contacts): free the contacts in the list after
	calling _respond_create_contacts to eliminate a large memory leak on
	importing a large number of contacts.  Fixes Bug 110765
	* addressbook/libedata-book-dbus/e-data-book.c
	(e_data_book_respond_create_contacts): use e_contact_get rather than
	e_contact_get_const so that we own the data and can free it after the idle
	handler has run.  Prevents a potential double-free error.

2009-04-14  Robert Peto  <robert.peto@maemo.org>

	* addressbook/libebook-dbus/e-book.c(e_book_add_contacts):
	Eliminate memory leak.

2009-04-14  Robert Peto  <robert.peto@maemo.org>

	Do not escape the newline and comma characters in case of 2.1 format
	in addressbook.

	* addressbook/libebook-dbus/e-vcard.c(_evc_escape_string_21)

2009-04-09  Robert Peto  <robert.peto@maemo.org>

	Switch file-backend's addressbook to read-only mode if index.db is not
	usable.

	* addressbook/backends/file/e-book-backend-file.c

2009-04-08  Marco Barisione  <marco.barisione@maemo.org>

	* backends/file/Makefile.am:
	* backends/file/e-book-backend-file-factory.c:
	(eds_module_initialize):
	* backends/file/e-book-backend-file-index.c:
	(e_book_backend_file_index_is_usable),
	(e_book_backend_file_index_query),
	(e_book_backend_file_index_setup_indicies),
	(e_book_backend_file_index_get_ordered_ids), (test_always_fails),
	(real_test_generic_field_is_indexed), (index_populate),
	(get_key_attribute), (get_key), (generic_name_add_cb),
	(generic_name_remove_cb), (generic_field_add),
	(generic_field_remove), (index_sync), (real_is_query),
	(real_query), (index_close_db_func):
	* backends/file/e-book-backend-file-log.c:
	* backends/file/e-book-backend-file-log.h:
	* backends/file/e-book-backend-file.c: (load_last_running_id),
	(e_book_backend_file_store_unique_id),
	(e_book_backend_file_create_unique_id), (insert_contact),
	(do_create), (e_book_backend_file_create_contacts),
	(e_book_backend_file_remove_contacts), (modify_contact),
	(e_book_backend_file_modify_contact),
	(e_book_backend_file_get_contact),
	(e_book_backend_file_get_contact_list), (book_view_thread),
	(e_book_backend_file_stop_book_view),
	(e_book_backend_file_set_book_view_sort_order),
	(e_book_backend_file_get_changes),
	(e_book_backend_file_upgrade_db), (file_errcall), (check_md5sum),
	(e_book_backend_file_setup_running_ids),
	(e_book_backend_file_load_source), (e_book_backend_file_remove),
	(e_book_backend_file_sync):
	Use the new logging functions in the file backend.

2009-04-08  Robert Peto  <robert.peto@maemo.org>

	Apply Xavier's performance patch:
	
	* addressbook/libebook-dbus/e-vcard.c (e_vcard_construct_with_uid(),
	  parse_idle_cb(), e_vcard_dispose()):
	Lazy parse vcards in an idle callback

	* addressbook/libebook-dbus/e-vcard.c (e_vcard_dispose()):
	Do not use e_vcard_add_attribute when parsing the vcard, we don't need
	change notification.

2009-04-07  Marco Barisione  <marco.barisione@maemo.org>

	* libedataserver/e-log.c:
	* libedataserver/e-log.h:
	* libedataserver/Makefile.am:
	* addressbook/libedata-book-dbus/e-data-book-factory.c:
	* addressbook/libedata-book-dbus/Makefile.am:
	Add logging functions that, using environment variables, allow to
	control which modules should print debug messages and how much verbose
	they should be.

2009-04-07  Robert Peto  <robert.peto@maemo.org>

	* addressbook/libebook-dbus/e-vcard.c (e_vcard_to_string_vcard_21):
	Only TYPE should be omitted. Don't quote strings that cointains only
	alphanumeric and dash characters, like UTF-8.

2009-04-06  Robert Peto  <robert.peto@maemo.org>

	* addressbook/libebook-dbus/e-vcard.c (_evc_base64_encode_simple):
	Prevent multiple integer overflows. Patch is applied from
	http://ocert.org/patches/2008-015/evc-CVE-2009-0587.diff

2009-04-02  Jonathon Jongsma  <jonathon.jongsma@maemo.org>

	* addressbook/libebook-dbus/e-contact.c (reset_cached_attribute):
	fix typo in function name, prevent a potential crash in strcmp in
	the case where vcard_field is null by using g_return_if_fail()

2009-04-02  Robert Peto  <robert.peto@maemo.org>

	Return non string attributes as well when calling
	e_contact_get_const().

	* addressbook/libebook-dbus/e-contact.c

2009-04-01  Jonathon Jongsma  <jonathon.jongsma@maemo.org>

	* addressbook/libedata-book-dbus/e-book-backend-cache.c:
	* libedataserver/e-account.c:
	Fix a couple more coverity findings.  Fixes: NB#108964 (most of those
	findings were already fixed in a previous commit)

2009-04-01  Jonathon Jongsma  <jonathon.jongsma@maemo.org>

	* addressbook/libebook-dbus/e-vcard.c (parse()):
	Fix a couple segfaults reported by arifa when running the vcard
	parsing test suite.  These segfaults happened because in some
	cases attributes were getting freed when they shouldn't have been
	and we crashed when we attempted to use them later.

2009-04-01  Jonathon Jongsma  <jonathon.jongsma@maemo.org>

	* addressbook/libedata-book-dbus/e-data-book.c:
	Do dbus method response (and error response) calls from an idle handler so
	that they are executed from the main thread since these responses could be
	executed from other threads and potentially cause dbus thread-safety issues.
	The idle handler's priority is HIGH_IDLE so that it will be higher than the
	telepathy backend, which does a lot of things in idle handlers.

2009-04-01  Jonathon Jongsma  <jonathon.jongsma@maemo.org>

	Fix parsing of broken vcards.  Don't abort on the first failure to read an
	attribute.  Instead, skip that line and continue parsing.  This should allow
	the user to import most of the information even if some fields of the vcard
	are corrupted.  Fixes NB#106483

	* addressbook/libebook-dbus/e-vcard.c (read_attribute(), parse()):
	when read_attribute() fails, just ignore that line and attempt to keep
	parsing the vcard.  This requires the behavior of read_attribute() to change
	such that it advances its char** argument to the next line even when parsing
	fails so that we don't attempt to re-parse the same invalid line over and
	over.

2009-03-31  Robert Peto  <robert.peto@maemo.org>

	Assemble change list in e_book_get_changes() in a more robust way.

	* addressbook/libebook-dbus/e-book.c

2009-03-31  Robert Peto  <robert.peto@maemo.org>

	Handle default directory in e_contact_persist_data()

	* addressbook/libebook-dbus/e-contact.c

2009-03-31  Robert Peto  <robert.peto@maemo.org>

	Fix returned uids in e_book_add_contacts in file backend.

	* addressbook/backends/file/e-book-backend-file.c

2009-03-30  Robert Peto  <robert.peto@maemo.org>

	Fix memory leaks in vcard parsing in addressbook. (by Xavier Claessens)

	* addressbook/libebook-dbus/e-vcard.c (parse())

2009-03-27  Robert Peto  <robert.peto@maemo.org>

	Fix various memleaks in addressbook.

	* addressbook/libedata-book-dbus/e-data-book-factory.c
	* addressbook/libedata-book-dbus/e-data-book.c
	* addressbook/libebook-dbus/e-book.c

2009-03-26  Robert Peto  <robert.peto@maemo.org>

	Fixes: NB#105292. Apply THRESHOLD macro for breaking the chunks at
	client side itself to avoid the mutex locking & unlocking issues at
	server side. (by Chittibabu Theegala)

	* configure.in: define THRESHOLD to 32.
	* addressbook/libedata-book-dbus/e-data-book-view.c: remove THRESHOLD
	  definition from here.
	* addressbook/libebook-dbus/e-book.c
	 (e_book_add_contacts_by_threshold_limit(), e_book_add_contacts())

2009-03-25  Mathias Hasselmann  <hasselmm@gnome.org>

	Fix NB#107422, NB#107544, NB#107928 and hopefully many other
	regressions.

	* addressbook/libebook-dbus/e-vcard.c (e_vcard_is_parsing()):
	  Properly implement this function. Seems I was tired when commiting
	  the old version.

2009-03-23  Robert Peto  <robert.peto@maemo.org>

	Fold lines properly while exporting to vCard 2.1.

	* addressbook/libebook-dbus/e-vcard.c (e_vcard_to_string_vcard_21())

2009-03-23  Robert Peto  <robert.peto@maemo.org>

	Return with duplicated ids from haystack instead of needles.

	* addressbook/libebook-dbus/e-book-util.c
	 (e_book_util_remove_duplicates())

2009-03-13  Robert Peto  <robert.peto@maemo.org>

	Convert contact to string in format 2.1: replace comma to semicolon
	for type attributes.

	* addressbook/libebook-dbus/e-vcard.c (e_vcard_to_string_vcard_21())

2009-03-12  Robert Peto  <robert.peto@maemo.org>

	API change in e-book-util, extra out parameter added for duplicate
	ids.

	* addressbook/libebook-dbus/e-book-util.c
	 (e_book_util_remove_duplicates(),
	  e_book_util_remove_duplicates_using_book())

2009-03-10  Robert Peto  <robert.peto@maemo.org>

	Apply line folding when importing to vCard 2.1 format and ENCODING is
	not set to QUOTED-PRINTABLE.

	* addressbook/libebook-dbus/e-vcard.c (e_vcard_to_string_vcard_21())

2009-03-03  Robert Peto  <robert.peto@maemo.org>

	Do not insert TYPE string while converting to string.

	* addressbook/libebook-dbus/e-vcard.c (e_vcard_to_string_vcard_21())

2009-03-03  Robert Peto  <robert.peto@maemo.org>

	* addressbook/backends/file/e-book-backend-file.c: protect
	  priv->running_id with a G_LOCK, open DB_ENV with DB_INIT_LOCK flag
	* addressbook/libebook-dbus/e-book-query.c (e_book_query_to_string()):
	  escape gently if EBookQuery is NULL

2009-02-24  Robert Peto  <robert.peto@maemo.org>

	Prevent crashes while disposing EDataBookView. Fixes: NB#101832.

	* libedataserver/e-sexp.c

2009-02-13  Robert Peto  <robert.peto@maemo.org>

	Fix decoding of QUOTED-PRINTABLE encoded attributes in EVCard.
	Fixes: NB#99991.

	* addressbook/libebook-dbus/e-vcard.c (read_attribute_value())

2009-02-12  Robert Peto  <robert.peto@maemo.org>

	Add Quoted Printable support for EVCardAttribute.

	* addressbook/libebook-dbus/e-vcard.c
	 (e_vcard_attribute_add_value_decoded(),
	  e_vcard_attribute_get_values_decoded()): see above
	* e_vcard_is_parsed(): fix return value if fail

2009-02-12  Robert Peto  <robert.peto@maemo.org>

	Fix "base64" encoding problem with PHOTO attribute.
	Fixes: NB#98290.

	* addressbook/libebook-dbus/e-contact.c (photo_getter())

2009-02-06  Robert Peto  <robert.peto@maemo.org>

	Fix error handling in e_book_add_contacts().

	* addressbook/libebook-dbus/e-book.c: see above.
	* addressbook/libedata-book-dbus/e-data-book.c
	 (e_data_book_respond_create_contacts()): Use g_strfreev() for
	allocated char **

2009-02-06  Robert Peto  <robert.peto@maemo.org>

	Fix running id issue in addressbook's file backend.

	* addressbook/backends/file/e-book-backend-file.c
	 (insert_contact())

2009-02-02  Robert Peto  <robert.peto@maemo.org>

	Fix indexing problem in addressbook's file backend. (When starting
	BookView contacts without name doesn't get back.)

	* addressbook/backends/file/e-book-backend-file.c
	* addressbook/backends/file/e-book-backend-file-index.c

2009-01-22  Robert Peto  <robert.peto@maemo.org>

	Fix loading of preinstalled vcards in addressbook's file backend.

	* addressbook/backends/file/e-book-backend-file.c
	 (e_book_backend_file_load_source()): See above.

2009-01-22  Robert Peto  <robert.peto@maemo.org>

	New util functions for prevent duplications in addressbook.

	* addressbook/libebook-dbus/e-book-util.c,
	  addressbook/libebook-dbus/e-book-util.h:
	 (e_book_util_remove_duplicates(),
	  e_book_util_remove_duplicates_using_book()): See above

2009-01-21  Robert Peto  <robert.peto@maemo.org>

	New API functions for persist / inline data in addressbook. (Currently only
	for PHOTO and LOGO properties.)

	* addressbook/libebook-dbus/e-contact.c
	 (e_contact_photo_convert_to_inlined(),
	  e_contact_photo_convert_to_uri(),
	  e_contact_inline_data(), e_contact_persist_data()): See above.
	* configure.in: linking addressbook to gio.

2009-01-16  Robert Peto  <robert.peto@maemo.org>

	Use EFlag in threaded operations of EBookBackend class to prevent them
	running before OPEN has finished.

	* addressbook/libedata-book-dbus/e-book-backend.c
	 (e_book_backend_open(), e_book_backend_create_contact(),
	  e_book_backend_create_contacts(), e_book_backend_remove_contacts(),
	  e_book_backend_modify_contact(), e_book_backend_modify_contacts(),
	  e_book_backend_get_contact(), e_book_backend_get_contact_list(),
	  e_book_backend_get_changes(), e_book_backend_authenticate_user(),
	  e_book_backend_init(), e_book_backend_dispose())

