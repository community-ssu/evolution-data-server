2009-07-31  Marco Barisione  <marco.barisione@collabora.co.uk>

	Don't leak the list of contacts after calling
	e_data_book_respond_get_contact_list.

	* libedata-book-dbus/e-book-backend-sync.c
	(_e_book_backend_get_contact_list):

	Reviewed-By: Robert Peto  <robert.peto@maemo.org>

2009-07-31  Robert Peto  <robert.peto@maemo.org>

	Free the DBusConnection properly when client is disconnected.

	* addressbook/libedata-book-dbus/e-data-book-view.c

	 (dbus_signal_filter_cb()): Add a signal handler for dbus connection
	  to check if the client is disconnected abruptly. It it did, then
	  dispose the book view object.

	 (impl_BookView_dispose()): Remove the signal filter function to
	  prevent getting dbus signals when we run the dispose.

	 (e_data_book_view_dispose()): Stop the book view if it is till running
	  when disposing.

	 (e_data_book_view_finalize(), unref_dbus_connection_cb()):
	  Unref the DBus connection in an idle handler.

	Reviewed-By: Mathias Hasselmann  <mathias.hasselmann@maemo.org>

2009-07-30  Robert Peto  <robert.peto@maemo.org>

	Close wrongly opened dbs before trying to open them again.

	* addressbook/backends/file/e-book-backend-file-index.c
	 (create_index_db()): cut out the creation and setup of DB object into
	  a separate function.
	 (e_book_backend_file_index_setup_indicies()): close and recreate the
	  DB object when trying to open 2nd time to avoid memleak.

	* addressbook/backends/file/e-book-backend-file.c
	 (e_book_backend_file_setup_running_ids()): close and recreate the DB
	  object when trying to open 2nd time to avoid memleak.

	Reviewed-By: Marco Barisione  <marco.barisione@maemo.org>

2009-07-29  Marco Barisione  <marco.barisione@collabora.co.uk>

	Lock the .changes.db file while using it so that the backup scripts
	don't try to save it when it's in an inconsistent state.

	* backends/file/e-book-backend-file.c
	(e_book_backend_file_get_changes):

	Reviewed-By: Jonathon Jongsma  <jonathon.jongsma@maemo.org>

2009-07-29  Marco Barisione  <marco.barisione@collabora.co.uk>

	Return an error code if an error occurs in
	e_book_backend_file_get_changes instead of always returning a success
	code.

	* backends/file/e-book-backend-file.c
	(e_book_backend_file_get_changes):

	Reviewed-By: Jonathon Jongsma  <jonathon.jongsma@maemo.org>

2009-07-29  Mathias Hasselmann  <mathias.hasselmann@maemo.org>

	NB#128596 - Improve robustness of e_contact_date_from_string()

	* addressbook/libebook-dbus/e-contact.c (e_contact_date_from_string()):
	  Use regular expression to accept wider range of date strings and to
	  improve error detection. Normalize parsed dates to sane values.

	Reviewed-By: Xavier Claessens  <xavier.claessens@maemo.org>

2009-07-28  Robert Peto  <robert.peto@maemo.org>

	Code cleanup.

	* addressbook/backends/file/e-book-backend-file.c: Remove global_env
	  struct and all related methods, since it can cause trouble with the
	  previously added changes.

	  e_book_backend_file_setup_running_ids(): cleanup, modify the return
	  value to int, to be consistent with the libdb functions.

	  e_book_backend_file_setup_db_env(): refactored from
	  setup_global_env(), all db_envs are EBookBackendFile specific.

	  e_book_backend_file_load_source(): follow the "exception pattern",
	  cleanup object's private variables under the error label in the end
	  of the function.

	  e_book_backend_file_dispose(): close the db_env as well.

2009-07-28  Robert Peto  <robert.peto@maemo.org>

	If the DB environment got corrupted then abort and the next start
	remove the corrupted DB, so we can start with an empty one.
	(See: NB#114835)

	* addressbook/backends/file/e-book-backend-file.c:
	  file_paniccall(): create a temp file in the db_home of the
	  environment.

	  setup_global_env(): create the db_home directory if it does not
	  exists already, open the env with this directory

	  e_book_backend_file_maybe_recover(): use this function to check and
	  recover if needed

	  e_book_backend_file_load_source(): remove redundant code.

2009-07-22  Robert Peto  <robert.peto@maemo.org>

	NB#129181 - Edited Contact is not reflected in all contacts view.

	* addressbook/backends/file/e-book-backend-file.c (sync_dbs()):
	  sync id_db when other dbs are synced.

	Reviewed-By: Marco Barisione  <marco.barisione@maemo.org>

2009-07-17  Mathias Hasselmann  <mathias.hasselmann@maemo.org>

	NB#122626 - Normalize attribute values during queries

	* addressbook/backends/file/e-book-backend-file-index.c:
	  Store stripped values in index table.

	* addressbook/libebook-dbus/e-book-sexp.c:
	  Normalize phone numbers for TEL field related queries.
	  Strip leading and trailing spaces for other attributes.

	Reviewed-By: Marco Barisione  <marco.barisione@maemo.org>

2009-07-16  Mathias Hasselmann  <mathias.hasselmann@maemo.org>

	NB#122626 - Introduce function for normalizing phone numbers.

	* addressbook/libebook-dbus/e-book-util.c:
	* addressbook/libebook-dbus/e-book-util.h:
	  Introduce e_normalize_phone_number().

	Reviewed-By: Marco Barisione  <marco.barisione@maemo.org>

2009-07-16  Mathias Hasselmann  <mathias.hasselmann@maemo.org>

	NB#122626 - Move EBookBackendSExp from libebook to cleanup layering.

	* addressbook/libebook-dbus/Makefile.am:
	* addressbook/libebook-dbus/e-book-sexp.c:
	* addressbook/libebook-dbus/e-book-sexp.h:
	  Add EBookSExp to libebook.

	* addressbook/libedata-book-dbus/e-book-backend-sexp.c:
	* addressbook/libedata-book-dbus/e-book-backend-sexp.h:
	  Make EBookBackendSExp a wrapper for EBookSExp.

	Reviewed-By: Marco Barisione  <marco.barisione@maemo.org>

2009-07-15  Robert Peto  <robert.peto@maemo.org>

	* addressbook/libebook-dbus/e-vcard.c (read_attribute_value()): Skip
	soft line breaks ("=\r\n") when parsing QP encoded values.

	Reviewed-By: Marco Barisione  <marco.barisione@maemo.org>

2009-07-14  Robert Peto  <robert.peto@maemo.org>

	Optimize the check of pre-installed cards. (related to NB#117500)

	* addressbook/backends/file/e-book-backend-file.c: Replace the old
	  md5checksum mechanism with mtime checking.

	Reviewed-By: Mathias Hasselmann  <mathias.hasselmann@maemo.org>

2009-07-13  Robert Peto  <robert.peto@maemo.org>

	Optimize file-backend's load_source. (related to NB#117500)

	* addressbook/backends/file/e-book-backend-file.c: open
	  running_id db in a separate file, remove priv->index_filename.
	* addressbook/backends/file/e-book-backend-file-index.c: open index
	  dbs in separate files, so in db->open doesn't need to sync them.

	Reviewed-By: Mathias Hasselmann  <mathias.hasselmann@maemo.org>

2009-07-13  Robert Peto  <robert.peto@maemo.org>

	Fix memory leaks when converting photo types.

	* addressbook/libebook-dbus/e-contact.c:
	 (e_contact_photo_convert_to_inlined(),
	  e_contact_photo_convert_to_uri()): Free allocated memory in
	photo->data.xxx when changing type.

	Reviewed-By: Mathias Hasselmann  <mathias.hasselmann@maemo.org>

2009-07-01  Jonathon Jongsma  <jonathon.jongsma@maemo.org>

	Reviewed by Marco Barisione  <marco.barisione@maemo.org>

	* libedata-book-dbus/e-data-book-factory.c:
	(my_remove):
	(impl_BookFactory_getBook): don't exit due to inactivity.  Under
	normal operation on the device, e-d-s should never exit anyway
	because addressbook will always be automatically re-started. So
	the only thing the exit timeout does is make our lives more
	difficult in the case that we are heavily loaded. Fixes NB#112135

2009-06-29  Marco Barisione  <marco.barisione@collabora.co.uk>

	NB#121193 - First and last name show incorrect information from a
	Me-card contact in certain conditions.

	We used to split long lines encoded in quoted-printable using a soft
	line break with a space at the beginning of new lines, i.e. "=\r\n ".
	This was breaking some other parsers that were inserting an extra
	whitespace instead of ignoring it, so in r570 we switched to use
	normal line breaks ("\r\n ").
	Some other parsers are not able to parse split lines that don't
	terminate with a "=", so this commit switches to use "=\r\n", with no
	extra whitespace.
	When using base64 we just split using "\r\n " as usual.

	* libebook-dbus/e-vcard.c (e_vcard_to_string_vcard_21): use "=\r\n" to
	split long lines encoded with quoted-printable.

	Reviewed-By: Robert Peto  <robert.peto@maemo.org>

2009-06-29  Mathias Hasselmann  <mathias.hasselmann@maemo.org>

	NB#125020 - Contacts doesnt get synced when all data types are synced
	from phone to rover.

	* addressbook/libebook-dbus/e-book.c (e_book_open(), open_reply()):
	* addressbook/libedata-book-dbus/e-book-backend.c (e_book_backend_open()):
	* addressbook/libedata-book-dbus/e-data-book.c (DBusMethodReturnBoolData,
	  dbus_method_return_bool_data_new(), dbus_method_return_bool_data_free(),
	  idle_dbus_method_return_bool(), e_data_book_respond_open()):
	* addressbook/libedata-book-dbus/e-data-book.h (e_data_book_respond_open()):
	* addressbook/libedata-book-dbus/e-data-book.xml
	 (org.gnome.evolution.dataserver.addressbook.Book.open()):
	  Pass initial writable flag via open call response instead of using a
	  separate signal to avoid latency and the need for connecting to
	  writable-status signal.

	Reviewed-By: Robert Peto  <robert.peto@maemo.org>

2009-06-29  Mathias Hasselmann  <mathias.hasselmann@maemo.org>

	Drop bogus AM_MAINTAINER_MODE.

	* configure.in: See summary.

	Reviewed-By: Robert Peto  <robert.peto@maemo.org>

2009-06-29  Mathias Hasselmann  <mathias.hasselmann@maemo.org>

	Use proper callback for remove-all-contacts call.

	* addressbook/libebook-dbus/e-book.c
	 (e_book_async_remove_all_contacts()): See summary.

	Reviewed-By: Robert Peto  <robert.peto@maemo.org>

2009-06-29  Mathias Hasselmann  <mathias.hasselmann@maemo.org>

	Various build fixes to make -Werror pass again.

	* addressbook/backends/file/e-book-backend-file-index.c
	 (index_sync()): Mark data argument as immutable.
	* addressbook/backends/file/e-book-backend-file.c
	 (e_book_backend_file_modify_contact()): Initialize db_error.
	* addressbook/libebook-dbus/e-book.c
	 (e_book_remove_all_contacts_fallback(),
	  remove_all_contacts_get_contacts_cb()): Make g_list_prepend() happy.
	* addressbook/libebook-dbus/e-contact.c
	 (e_contact_photo_convert_to_inlined()): Make g_content_type_guess() happy.
	* addressbook/libebook-dbus/e-vcard.c (e_vcard_construct_with_uid()):
	  Properly return FALSE instead of NULL on error.

	Reviewed-By: Robert Peto  <robert.peto@maemo.org>

2009-06-26  Mathias Hasselmann  <mathias.hasselmann@maemo.org>

	NB#101759 - Contact editor dialog does not close after tapping on Save
	button

	* addressbook/libedata-book-dbus/e-data-book-view.c:
	  Drop thaw_lock and use pending_mutex instead to avoid dead-looks.
	  Expect for e_data_book_view_thaw() they are identical anyway, and
	  for the thaw function it's acceptable to wait for pending_mutex.
	  Turn pending_mutex into a GStaticRecMutex so that we can make sure
	  to really have the lock in notify_add(). Reuse existing thaw idle
	  handler to avoid needlessly defering thawing of the book view.

	Reviewed-By: Robert Peto  <robert.peto@maemo.org>

2009-06-23  Robert Peto  <robert.peto@maemo.org>

	* addressbook/backends/file/e-book-backend-file.c
	(e_book_backend_file_load_source()): Unref bf->priv->index if
	running_id couldn't be loaded.

	Reviewed-By: Mathias Hasselmann  <mathias.hasselmann@maemo.org>

2009-06-22  Robert Peto  <robert.peto>

	* addressbook/backends/file/e-book-backend-file-index.c
	(e_book_backend_file_index_setup_indicies(),
	e_book_backend_file_index_get_ordered_ids()): handle db_error return
	values.

	Reviewed-By: Jonathon Jongsma  <jonathon.jongsma@maemo.org>

2009-06-22  Robert Peto  <robert.peto@maemo.org>

	Set up a panic callback for berkeley db in addressbook. If DB file
	gets corrupted (recovery is needed) E-D-S will abort immediately.

	* addressbook/backends/file/e-book-backend-file.c

	Reviewed-By: Jonathon Jongsma  <jonathon.jongsma@maemo.org>

2009-06-17  Robert Peto  <robert.peto@maemo.org>

	Remove redundant writable checks from the file-backend of addressbook.

	* addressbook/backends/file/e-book-backend-file.c
	(e_book_backend_file_create_contact(),
	 e_book_backend_file_create_contacts(),
	 e_book_backend_file_remove_contacts(),
	 e_book_backend_file_modify_contact(),
	 e_book_backend_file_modify_contacts())

	Reviewed-By: Mathias Hasselmann  <mathias.hasselmann@maemo.org>

2009-06-17  Robert Peto  <robert.peto@maemo.org>

	Do not allow DB modifications on a not writable addressbook.

	* addressbook/libebook-dbus/e-book.c: chech if EBook if writable
	before calling methods that are doing DB modifications (add, modify,
	remove).
	* addressbook/libedata-book-dbus/e-book-backend.c: check if
	EBookBackend is writable before calling methods that doind DB
	modifications.

	Reviewed-By: Mathias Hasselmann  <mathias.hasselmann@maemo.org>

2009-06-17  Robert Peto  <robert.peto@maemo.org>

	Do not allow DB operations on a not loaded addressbook.

	* addressbook/libebook-dbus/e-book.c: check if EBook is loaded before
	calling its DB related methods.
	* addressbook/libedata-book-dbus/e-book-backend.c: check if
	EBookBackend is loaded before calling its DB related methods.

	Reviewed-By: Mathias Hasselmann  <mathias.hasselmann@maemo.org>

2009-06-10  Jonathon Jongsma  <jonathon.jongsma@maemo.org>

	Reviewed by Mathias Hasselmann  <mathias.hasselmann@maemo.org>

	* libebook-dbus/e-contact.c:
	(e_contact_new_from_vcard): don't do a duplicate utf-8 validation
	* libebook-dbus/e-vcard.c:
	(e_vcard_construct):
	(e_vcard_construct_with_uid): return a boolean value indicating whether
	the construction was successful (e.g. whether there was invalid utf-8 or
	not)
	(e_vcard_new_from_string): don't do a duplicate utf-8 validation
	* libebook-dbus/e-vcard.h: change return values

2009-06-08  Jonathon Jongsma  <jonathon.jongsma@maemo.org>

	Make sure we don't pass invalid utf-8 strings over D-Bus,
	otherwise the client application will be forcefully disconnected
	from the bus and the client application will abort. Fixes NB#111264

	* libebook-dbus/e-contact.c:
	(e_contact_new_from_vcard): return NULL if passed string is invalid utf-8
	* libebook-dbus/e-vcard.c:
	(e_vcard_new_from_string): return NULL if string is invalid utf-8
	(e_vcard_construct_with_uid): validate strings as utf-8
	(e_vcard_to_string): make sure the returned string is valid
	utf-8 or otherwise return NULL
	* libebook-dbus/e-book.c: handle NULL responses from
	e_vcard_to_string and return error status codes when this
	happens.  Also validate all string input from API functions.

	Reviewed by Mathias Hasselmann  <mathias.hasselmann@maemo.org>

2009-06-15  Mathias Hasselmann  <mathias.hasselmann@maemo.org>

	Rewire im-gadugadu in SEXP handler.

	* addressbook/libedata-book-dbus/e-book-backend-sexp.c
	 (prop_info[]): See summary.

	Reviewed-By: Robert Peto  <robert.peto@maemo.org>

2009-06-15  Mathias Hasselmann  <mathias.hasselmann@maemo.org>

	Gracefully handle missing virtual methods.

	* addressbook/libedata-book-dbus/e-book-backend.c:
	* addressbook/libedata-book-dbus/e-book-backend-sync.c:
	  Now gracefully handle all virtual methods.

	Reviewed-By: Robert Peto  <robert.peto@maemo.org>

2009-06-10  Mathias Hasselmann  <mathias.hasselmann@maemo.org>

	Provide fallback for remove-all-contacts method (see NB#105728).

	* addressbook/libebook-dbus/e-book.c
	 (e_book_remove_all_contacts_fallback(), e_book_remove_all_contacts(),
	  remove_all_contacts_get_contacts_cb(),
	  e_book_async_remove_all_contacts_fallback(),
	  e_book_async_remove_all_contacts()):
	  Emulate remove-all-contacts call when the backend doesn't have
	  the "remove-all-contacts" capability.

	Reviewed-By: Robert Peto  <robert.peto@maemo.org>

2009-06-10  Mathias Hasselmann  <mathias.hasselmann@maemo.org>

	Gracefully handle missing virtual methods (see NB#105728).

	* addressbook/libedata-book-dbus/e-book-backend-sync.c
	 (E_BOOK_BACKEND_SYNC_CHECK_METHOD(),
	  e_book_backend_sync_remove_all_contacts()):
	* addressbook/libedata-book-dbus/e-book-backend.c
	 (E_BOOK_BACKEND_CHECK_METHOD(),
	  e_book_backend_remove_all_contacts()):
	  Print a warning and return OtherError instead of crashing when
	  remove_all_contacts() is not implemented.

	Reviewed-By: Robert Peto  <robert.peto@maemo.org>

2009-06-10  Mathias Hasselmann  <mathias.hasselmann@maemo.org>

	NB#105728 - API change request: delete all contacts

	* addressbook/libebook-dbus/e-book.c (e_book_remove_all_contacts(),
	  remove_all_contacts_reply(), e_book_async_remove_all_contacts()):
	* addressbook/libebook-dbus/e-book.h
	 (e_book_remove_all_contacts(), e_book_async_remove_all_contacts()):
	  Introduce D-Bus wrappers for removeAllContacts method.

	* addressbook/libedata-book-dbus/e-book-backend-sync.c
	 (e_book_backend_sync_remove_all_contacts(),
	  _e_book_backend_remove_all_contacts(), e_book_backend_sync_class_init()):
	* addressbook/libedata-book-dbus/e-book-backend-sync.h
	 (EBookBackendSyncClass, e_book_backend_sync_remove_all_contacts()):
	  Provide hooks for synchronous version of removeAllContacts method.

	* addressbook/libedata-book-dbus/e-book-backend.c
	 (e_book_backend_remove_all_contacts()):
	* addressbook/libedata-book-dbus/e-book-backend.h
	 (EBookBackendClass, e_book_backend_remove_all_contacts()):
	  Provide hooks for asynchronous version of removeAllContacts method.

	* addressbook/libedata-book-dbus/e-data-book.c (OperationID,
	  operation_thread(), impl_AddressBook_Book_removeAllContacts(),
	  e_data_book_respond_remove_all_contacts()):
	* addressbook/libedata-book-dbus/e-data-book.h
	 (e_data_book_respond_remove_all_contacts()):
	* addressbook/libedata-book-dbus/e-data-book.xml
	 (org.gnome.evolution.dataserver.addressbook.Book):
	  Introduce removeAllContacts DBus method.

	Reviewed-By: Robert Peto  <robert.peto@maemo.org>

2009-06-08  Mathias Hasselmann  <mathias.hasselmann@maemo.org>

	NB#97387 - Sometimes e_book_async_open() ends in Nirwana

	* addressbook/libebook-dbus/e-book.c:
	  Report E_BOOK_ERROR_CORBA_EXCEPTION when async calls fail because
	  of a broken DBus connection.

	Reviewed-By: Robert Peto  <robert.peto@maemo.org>

2009-06-09  Mathias Hasselmann  <mathias.hasselmann@maemo.org>

	NB#97387 - Sometimes e_book_async_open() ends in Nirwana

	* addressbook/libebook-dbus/e-book.c:
	  Report E_BOOK_ERROR_CORBA_EXCEPTION when async calls fail because
	  of a broken DBus connection.

	Reviewed-By: Robert Peto  <robert.peto@maemo.org>

2009-06-04  Jonathon Jongsma  <jonathon.jongsma@maemo.org>

	Reviewed by Travis Reitter  <travis.reitter@maemo.org>

	* libedata-book-dbus/e-book-backend.c:
	(e_book_backend_remove_contacts): if we're passed an empty list of ids
	to remove, simply respond 'Success' rather than just dropping the
	request and letting the caller time out waiting for a dbus response
	Fixes NB#120845

2009-06-04  Robert Peto  <robert.peto@maemo.org>

	Only sync addressbook's index db when it is necessary.

	* addressbook/backends/file/e-book-backend-file-index.c
	(e_book_backend_file_index_setup_indicies()): only sync when index dbs
	wasn't exist before
	* addressbook/backends/file/e-book-backend-file.c
	(install_pre_installed_vcards()): only sync when pre-installed cards
	are inserted

2009-06-02  Robert Peto  <robert.peto@maemo.org>

	Fix debug packages.

	* debian/rules: Remove DEB_DH_STRIP_ARGS since it does not work with
	multiple packages, and CDBS is smart enough to find out the dh_strip
	args from the control file.

2009-06-02  Robert Peto  <robert.peto@maemo.org>

	Notify book-views only after return values has been sent back to
	requestor.

	* addressbook/libedata-book-dbus/e-data-book.c
	(e_data_book_respond_create_contacts(),
	 e_data_book_respond_modify_contacts(),
	 e_data_book_respond_remove_contacts()): send return value before
	 signaling book-views.

2009-05-27  Robert Peto  <robert.peto@maemo.org>

	Put running_id to DB after installing pre-installed contacts, so it
	won't lost when the factory exists.

	* addressbook/backends/file/e-book-backend-file.c
	(install_pre_installed_vcards())

	Reviewed-By: Marco Barisione  <marco.barisione@maemo.org>

2009-05-25  Robert Peto  <robert.peto@maemo.org>

	The new InvalidField error type was partially defined as a solution,
	handle it on client side as well.

	* addressbook/libebook-dbus/e-book-types.h
	* addressbook/libebook-dbus/e-book.c

	Patch-By: Travis Reitter  <travis.reitter@maemo.org>

2009-05-21  Robert Peto  <robert.peto@maemo.org>

	Do not use soft-line break when folding long QP encoded values, since
	some parsers can not handle it.

	* addressbook/libebook-dbus/e-vcard.c (e_vcard_to_string_vcard_21 ())

	Reviewed-By: Marco Barisione  <marco.barisione@maemo.org>

2009-05-20  Robert Peto  <robert.peto@maemo.org>

	Use e-log in EDataBookView.

	* addressbook/libedata-book-dbus/e-data-book-view.c
	(e_data_book_view_class_init(), impl_BookView_set_freezable(),
	e_data_book_view_set_thresholds()): replace g_debug with proper
	macros.

2009-05-15  Robert Peto  <robert.peto@maemo.org>

	Skip empty lines (CRLF) while parsing vcards. It is needed since in
	vCard 2.1 there is an empty line after binary encoded values.

	* addressbook/libebook-dbus/e-vcard.c (skip_empty_lines(),
	read_attribute())

	Reviewed-By: Marco Barisione  <marco.barisione@maemo.org>

2009-05-15  Robert Peto  <robert.peto@maemo.org>

	Convert different CHARSET to utf8 while parsing vcard, this way we
	handle only utf8 charsets internally.

	* addressbook/libebook-dbus/e-vcard.c (attribute_add_value_utf8(),
	read_attribute_value())

	Reviewed-By: Marco Barisione  <marco.barisione@maemo.org>

2009-05-15  Robert Peto  <robert.peto@maemo.org>

	Set default log domain to "all" and default debug level to WARNING, so
	we get valuable syslogs even when those variables are not set
	explicitely.

	* libedataserver/e-log.c

	Reviewed-By: Marco Barisione  <marco.barisione@maemo.org>

2009-05-12  Marco Barisione  <marco.barisione@maemo.org>

	Add an error code for when some contact fields are invalid.

	* libedata-book-dbus/e-data-book-types.h: Add the InvalidField error
	code.

	Reviewed-By: Robert Peto <robert.peto@maemo.org>

2009-05-12  Robert Peto  <robert.peto@maemo.org>

	Fix reference counting issue in file backend's global db environment.
	Refcount is increased/decreased from now by one.

	* addressbook/backends/file/e-book-backend-file.c (setup_global_env(),
	unref_global_env(), e_book_backend_file_load_source()):
	Cut out the creation of global environment from
	e_book_backend_file_load_source() and create a new function for it.
	Create a reverese function (unref_global_env())	as well. Update
	e_book_backend_file_dispose().

	Reviewed-By: Mathias Hasselmann  <mathias.hasselmann@maemo.org>

2009-05-12  Robert Peto  <robert.peto@maemo.org>

	* addressbook/backends/file/e-book-backend-file.c
	(e_book_backend_file_remove_contacts()): Unref removed_contacts' data
	while freeing the list.

	Reviewed-By: Jonathon Jongsma  <jonathon.jongsma@maemo.org>

2009-05-12  Robert Peto  <robert.peto@maemo.org>

	* addressbook/backends/file/e-book-backend-file.c
	(e_book_backend_file_finalize()): Free sort_order private variable.

	Reviewed-By: Jonathon Jongsma  <jonathon.jongsma@maemo.org>

2009-05-12  Robert Peto  <robert.peto@maemo.org>

	* addressbook/backends/file/e-book-backend-file.c
	(book_view_thread()): Free properly the GPtrArray *ids variable.

	Reviewed-By: Jonathon Jongsma  <jonathon.jongsma@maemo.org>

2009-05-12  Robert Peto  <robert.peto@maemo.org>

	* addressbook/backends/file/e-book-backend-file.c
	(load_last_running_id()): Free cursor's data that is allocated by
	BerkeleyDB but file-backend own it.

	Reviewed-By: Jonathon Jongsma  <jonathon.jongsma@maemo.org>

2009-05-12  Robert Peto  <robert.peto@maemo.org>

	* addressbook/backends/file/e-book-backend-file-index.c
	(e_book_backend_file_index_get_ordered_ids()): Free stat struct

	Reviewed-By: Jonathon Jongsma  <jonathon.jongsma@maemo.org>

2009-05-12  Robert Peto  <robert.peto@maemo.org>

	* addressbook/libedata-book-dbus/e-data-book-view.c
	(e_data_book_view_finalize()): Free the memory blocks that belongs to
	the pointer arrays in priv struct, since we don't want them after
	e_data_book_view_finalize() has run.

	Reviewed-By: Jonathon Jongsma  <jonathon.jongsma@maemo.org>

2009-05-11  Robert Peto  <robert.peto@maemo.org>

	* addressbook/backends/file/e-book-backend-file.c (insert_contact()):
	Persist attached photos to ensure no image data is stored in main db,
	thus reducing its size and ease down DBus traffic.

	Reviewed-By: Joergen Scheibengruber <jorgen.scheibengruber@nokia.com>

2009-05-11  Robert Peto  <robert.peto@maemo.org>

	* addressbook/backends/file/e-book-backend-file.c
	  get_contact_from_string(): Optimize the reading of pre-installed
	  contacts.
	  install_pre_installed_vcards(): Apply modifications that are needed
	  for changed function signature. Don't return immediately when an
	  error happens during parsing the pre-installed files, try the next
	  one instead. Free the read file contents that caused leaks.

	Reviewed-By: Joergen Scheibengruber <jorgen.scheibengruber@nokia.com>

2009-05-06  Robert Peto  <robert.peto@maemo.org>

	Fix memory leak in file-backend.

	* addressbook/backends/file/e-book-backend-file.c
	(e_book_backend_file_get_contact_list()): Free coursor's data if we
	are not interested to keep it.

	Reviewed-By: Jonathon Jongsma  <jonathon.jongsma@maemo.org>

2009-05-06  Robert Peto  <robert.peto@maemo.org>

	Fix memory leak in file-backend.

	* addressbook/backends/file/e-book-backend-file.c
	(install_pre_installed_vcards()): Close GDir when escaping

	Reviewed-By: Jonathon Jongsma  <jonathon.jongsma@maemo.org>

2009-05-06  Robert Peto  <robert.peto@maemo.org>

	Convert date parameters to ISO 8601 basic format since some 2.1
	parsers can handle only this.

	* addressbook/libebook-dbus/e-vcard.c (e_vcard_to_string_vcard_21 ())

	Reviewed-By: Jonathon Jongsma  <jonathon.jongsma@maemo.org>

2009-05-06  Robert Peto  <robert.peto@maemo.org>

	NB#111407 - e-d-s crash in e_book_backend_file_load_source ()
	NB#111722 - Customized preinstalled contact is not shown in Contacts.

	* addressbook/backends/file/e-book-backend-file.c
	(e_book_backend_file_load_source()): assign addressbook's DB after it
	has been created successfully.

	Reviewed-By: Joergen Scheibengruber <jorgen.scheibengruber@nokia.com>

2009-04-29  Marco Barisione  <marco.barisione@maemo.org>

	reviewed by: Robert Peto

	* libebook-dbus/e-book.c (get_required_fields_reply),
	(get_supported_fields_reply), (get_supported_auth_methods_reply),
	(get_changes_reply), (add_contacts_reply), (get_book_view_reply):
	In case of error don't use the return values of D-Bus calls as they
	are uninitialised garbage.

2009-04-27  Robert Peto  <robert.peto@maemo.org>

	* addressbook/libebook-dbus/e-vcard.c (read_attribute_value(),
	read_attribute_params(), read_attribute()): Check CHARSET parameter
	and convert different charsets to UTF-8.

	* e_vcard_to_string_vcard_21(): Put CHARSET=UTF-8 string where
	QUOTED-PRINTABLE encoding is applied, since we represent all strings
	in UTF-8 internally.

2009-04-23  Robert Peto  <robert.peto@maemo.org>

	Pupulate back the removed ids after contacts are deleted in file-backend.

	* addressbook/backends/file/e-book-backend-file.c
	 (e_book_backend_file_remove_contacts())

2009-04-22  Robert Peto  <robert.peto@maemo.org>

	Sync both main db and index db when file-backend's sync method is
	called.

2009-04-21  Robert Peto  <robert.peto@maemo.org>

	* addressbook/libedata-book-dbus/e-book-backend.c
	(e_book_backend_start_book_view(), e_book_backend_stop_book_view()):
	Start/Stop book views only after backend is loaded.

2009-04-16  Jonathon Jongsma  <jonathon.jongsma@maemo.org>

	* addressbook/libebook-dbus/e-book.c:
	Take a ref on the EBook* or EBookQuery* variables when we use them for async
	dbus calls.  Only one of the functions in this file actually reffed the
	object that it was holding.  So I added some helper functions to
	automatically ref and unref these variables when creating / freeing the
	AsyncData structs.  Fixes: NB#108665

2009-04-16  Jonathon Jongsma  <jonathon.jongsma@maemo.org>

	* addressbook/libebook-dbus/e-vcard.c:
	un-revert a couple changes that should not have been reverted with the lazy parsing.

2009-04-16  Jonathon Jongsma  <jonathon.jongsma@maemo.org>

	* Revert lazy vcard parsing since it was causing too many regressions

2009-04-15  Jonathon Jongsma  <jonathon.jongsma@maemo.org>

	* addressbook/libedata-book-dbus/e-data-book-view.c:
	revert commit below freeing ptr array segment because it was causing crashes

2009-04-15  Robert Peto  <robert.peto@maemo.org>

	* addressbook/libebook-dbus/e-vcard.c (e_vcard_to_string_vcard_21):
	Insert an exra new line after every base64 encoded value.

2009-04-14  Jonathon Jongsma  <jonathon.jongsma@maemo.org>

	* addressbook/libedata-book-dbus/e-data-book-view.c:
	Fix leak by freeing the ptr array segment.  valgrind report:
		==27370== 896 bytes in 4 blocks are definitely lost in loss record 13 of 30
		==27370==    at 0x47E7C19: malloc (vg_replace_malloc.c:207)
		==27370==    by 0x47E7D5F: realloc (vg_replace_malloc.c:429)
		==27370==    by 0x718FB13: g_realloc (gmem.c:170)
		==27370==    by 0x7162C12: g_ptr_array_maybe_expand (garray.c:414)
		==27370==    by 0x71630C5: g_ptr_array_sized_new (garray.c:379)
		==27370==    by 0x47F9498: e_data_book_view_init (e-data-book-view.c:146)
		==27370==    by 0x4A9C28E: g_type_create_instance (gtype.c:1674)
		==27370==    by 0x4A80B90: g_object_constructor (gobject.c:1334)
		==27370==    by 0x4A7F5CD: g_object_newv (gobject.c:1211)
		==27370==    by 0x4A800CF: g_object_new_valist (gobject.c:1274)
		==27370==    by 0x4A80216: g_object_new (gobject.c:1056)
		==27370==    by 0x47F8F8F: e_data_book_view_new (e-data-book-view.c:229)

2009-04-14  Jonathon Jongsma  <jonathon.jongsma@maemo.org>

	* addressbook/libedata-book/e-book-backend-sync.c
	(_e_book_backend_create_contacts): free the contacts in the list after
	calling _respond_create_contacts to eliminate a large memory leak on
	importing a large number of contacts.  Fixes Bug 110765
	* addressbook/libedata-book-dbus/e-data-book.c
	(e_data_book_respond_create_contacts): use e_contact_get rather than
	e_contact_get_const so that we own the data and can free it after the idle
	handler has run.  Prevents a potential double-free error.

2009-04-14  Robert Peto  <robert.peto@maemo.org>

	* addressbook/libebook-dbus/e-book.c(e_book_add_contacts):
	Eliminate memory leak.

2009-04-14  Robert Peto  <robert.peto@maemo.org>

	Do not escape the newline and comma characters in case of 2.1 format
	in addressbook.

	* addressbook/libebook-dbus/e-vcard.c(_evc_escape_string_21)

2009-04-09  Robert Peto  <robert.peto@maemo.org>

	Switch file-backend's addressbook to read-only mode if index.db is not
	usable.

	* addressbook/backends/file/e-book-backend-file.c

2009-04-08  Marco Barisione  <marco.barisione@maemo.org>

	* backends/file/Makefile.am:
	* backends/file/e-book-backend-file-factory.c:
	(eds_module_initialize):
	* backends/file/e-book-backend-file-index.c:
	(e_book_backend_file_index_is_usable),
	(e_book_backend_file_index_query),
	(e_book_backend_file_index_setup_indicies),
	(e_book_backend_file_index_get_ordered_ids), (test_always_fails),
	(real_test_generic_field_is_indexed), (index_populate),
	(get_key_attribute), (get_key), (generic_name_add_cb),
	(generic_name_remove_cb), (generic_field_add),
	(generic_field_remove), (index_sync), (real_is_query),
	(real_query), (index_close_db_func):
	* backends/file/e-book-backend-file-log.c:
	* backends/file/e-book-backend-file-log.h:
	* backends/file/e-book-backend-file.c: (load_last_running_id),
	(e_book_backend_file_store_unique_id),
	(e_book_backend_file_create_unique_id), (insert_contact),
	(do_create), (e_book_backend_file_create_contacts),
	(e_book_backend_file_remove_contacts), (modify_contact),
	(e_book_backend_file_modify_contact),
	(e_book_backend_file_get_contact),
	(e_book_backend_file_get_contact_list), (book_view_thread),
	(e_book_backend_file_stop_book_view),
	(e_book_backend_file_set_book_view_sort_order),
	(e_book_backend_file_get_changes),
	(e_book_backend_file_upgrade_db), (file_errcall), (check_md5sum),
	(e_book_backend_file_setup_running_ids),
	(e_book_backend_file_load_source), (e_book_backend_file_remove),
	(e_book_backend_file_sync):
	Use the new logging functions in the file backend.

2009-04-08  Robert Peto  <robert.peto@maemo.org>

	Apply Xavier's performance patch:
	
	* addressbook/libebook-dbus/e-vcard.c (e_vcard_construct_with_uid(),
	  parse_idle_cb(), e_vcard_dispose()):
	Lazy parse vcards in an idle callback

	* addressbook/libebook-dbus/e-vcard.c (e_vcard_dispose()):
	Do not use e_vcard_add_attribute when parsing the vcard, we don't need
	change notification.

2009-04-07  Marco Barisione  <marco.barisione@maemo.org>

	* libedataserver/e-log.c:
	* libedataserver/e-log.h:
	* libedataserver/Makefile.am:
	* addressbook/libedata-book-dbus/e-data-book-factory.c:
	* addressbook/libedata-book-dbus/Makefile.am:
	Add logging functions that, using environment variables, allow to
	control which modules should print debug messages and how much verbose
	they should be.

2009-04-07  Robert Peto  <robert.peto@maemo.org>

	* addressbook/libebook-dbus/e-vcard.c (e_vcard_to_string_vcard_21):
	Only TYPE should be omitted. Don't quote strings that cointains only
	alphanumeric and dash characters, like UTF-8.

2009-04-06  Robert Peto  <robert.peto@maemo.org>

	* addressbook/libebook-dbus/e-vcard.c (_evc_base64_encode_simple):
	Prevent multiple integer overflows. Patch is applied from
	http://ocert.org/patches/2008-015/evc-CVE-2009-0587.diff

2009-04-02  Jonathon Jongsma  <jonathon.jongsma@maemo.org>

	* addressbook/libebook-dbus/e-contact.c (reset_cached_attribute):
	fix typo in function name, prevent a potential crash in strcmp in
	the case where vcard_field is null by using g_return_if_fail()

2009-04-02  Robert Peto  <robert.peto@maemo.org>

	Return non string attributes as well when calling
	e_contact_get_const().

	* addressbook/libebook-dbus/e-contact.c

2009-04-01  Jonathon Jongsma  <jonathon.jongsma@maemo.org>

	* addressbook/libedata-book-dbus/e-book-backend-cache.c:
	* libedataserver/e-account.c:
	Fix a couple more coverity findings.  Fixes: NB#108964 (most of those
	findings were already fixed in a previous commit)

2009-04-01  Jonathon Jongsma  <jonathon.jongsma@maemo.org>

	* addressbook/libebook-dbus/e-vcard.c (parse()):
	Fix a couple segfaults reported by arifa when running the vcard
	parsing test suite.  These segfaults happened because in some
	cases attributes were getting freed when they shouldn't have been
	and we crashed when we attempted to use them later.

2009-04-01  Jonathon Jongsma  <jonathon.jongsma@maemo.org>

	* addressbook/libedata-book-dbus/e-data-book.c:
	Do dbus method response (and error response) calls from an idle handler so
	that they are executed from the main thread since these responses could be
	executed from other threads and potentially cause dbus thread-safety issues.
	The idle handler's priority is HIGH_IDLE so that it will be higher than the
	telepathy backend, which does a lot of things in idle handlers.

2009-04-01  Jonathon Jongsma  <jonathon.jongsma@maemo.org>

	Fix parsing of broken vcards.  Don't abort on the first failure to read an
	attribute.  Instead, skip that line and continue parsing.  This should allow
	the user to import most of the information even if some fields of the vcard
	are corrupted.  Fixes NB#106483

	* addressbook/libebook-dbus/e-vcard.c (read_attribute(), parse()):
	when read_attribute() fails, just ignore that line and attempt to keep
	parsing the vcard.  This requires the behavior of read_attribute() to change
	such that it advances its char** argument to the next line even when parsing
	fails so that we don't attempt to re-parse the same invalid line over and
	over.

2009-03-31  Robert Peto  <robert.peto@maemo.org>

	Assemble change list in e_book_get_changes() in a more robust way.

	* addressbook/libebook-dbus/e-book.c

2009-03-31  Robert Peto  <robert.peto@maemo.org>

	Handle default directory in e_contact_persist_data()

	* addressbook/libebook-dbus/e-contact.c

2009-03-31  Robert Peto  <robert.peto@maemo.org>

	Fix returned uids in e_book_add_contacts in file backend.

	* addressbook/backends/file/e-book-backend-file.c

2009-03-30  Robert Peto  <robert.peto@maemo.org>

	Fix memory leaks in vcard parsing in addressbook. (by Xavier Claessens)

	* addressbook/libebook-dbus/e-vcard.c (parse())

2009-03-27  Robert Peto  <robert.peto@maemo.org>

	Fix various memleaks in addressbook.

	* addressbook/libedata-book-dbus/e-data-book-factory.c
	* addressbook/libedata-book-dbus/e-data-book.c
	* addressbook/libebook-dbus/e-book.c

2009-03-26  Robert Peto  <robert.peto@maemo.org>

	Fixes: NB#105292. Apply THRESHOLD macro for breaking the chunks at
	client side itself to avoid the mutex locking & unlocking issues at
	server side. (by Chittibabu Theegala)

	* configure.in: define THRESHOLD to 32.
	* addressbook/libedata-book-dbus/e-data-book-view.c: remove THRESHOLD
	  definition from here.
	* addressbook/libebook-dbus/e-book.c
	 (e_book_add_contacts_by_threshold_limit(), e_book_add_contacts())

2009-03-25  Mathias Hasselmann  <mathias.hasselmann@maemo.org>

	Fix NB#107422, NB#107544, NB#107928 and hopefully many other
	regressions.

	* addressbook/libebook-dbus/e-vcard.c (e_vcard_is_parsing()):
	  Properly implement this function. Seems I was tired when commiting
	  the old version.

2009-03-23  Robert Peto  <robert.peto@maemo.org>

	Fold lines properly while exporting to vCard 2.1.

	* addressbook/libebook-dbus/e-vcard.c (e_vcard_to_string_vcard_21())

2009-03-23  Robert Peto  <robert.peto@maemo.org>

	Return with duplicated ids from haystack instead of needles.

	* addressbook/libebook-dbus/e-book-util.c
	 (e_book_util_remove_duplicates())

2009-03-13  Robert Peto  <robert.peto@maemo.org>

	Convert contact to string in format 2.1: replace comma to semicolon
	for type attributes.

	* addressbook/libebook-dbus/e-vcard.c (e_vcard_to_string_vcard_21())

2009-03-12  Robert Peto  <robert.peto@maemo.org>

	API change in e-book-util, extra out parameter added for duplicate
	ids.

	* addressbook/libebook-dbus/e-book-util.c
	 (e_book_util_remove_duplicates(),
	  e_book_util_remove_duplicates_using_book())

2009-03-10  Robert Peto  <robert.peto@maemo.org>

	Apply line folding when importing to vCard 2.1 format and ENCODING is
	not set to QUOTED-PRINTABLE.

	* addressbook/libebook-dbus/e-vcard.c (e_vcard_to_string_vcard_21())

2009-03-03  Robert Peto  <robert.peto@maemo.org>

	Do not insert TYPE string while converting to string.

	* addressbook/libebook-dbus/e-vcard.c (e_vcard_to_string_vcard_21())

2009-03-03  Robert Peto  <robert.peto@maemo.org>

	* addressbook/backends/file/e-book-backend-file.c: protect
	  priv->running_id with a G_LOCK, open DB_ENV with DB_INIT_LOCK flag
	* addressbook/libebook-dbus/e-book-query.c (e_book_query_to_string()):
	  escape gently if EBookQuery is NULL

2009-02-24  Robert Peto  <robert.peto@maemo.org>

	Prevent crashes while disposing EDataBookView. Fixes: NB#101832.

	* libedataserver/e-sexp.c

2009-02-13  Robert Peto  <robert.peto@maemo.org>

	Fix decoding of QUOTED-PRINTABLE encoded attributes in EVCard.
	Fixes: NB#99991.

	* addressbook/libebook-dbus/e-vcard.c (read_attribute_value())

2009-02-12  Robert Peto  <robert.peto@maemo.org>

	Add Quoted Printable support for EVCardAttribute.

	* addressbook/libebook-dbus/e-vcard.c
	 (e_vcard_attribute_add_value_decoded(),
	  e_vcard_attribute_get_values_decoded()): see above
	* e_vcard_is_parsed(): fix return value if fail

2009-02-12  Robert Peto  <robert.peto@maemo.org>

	Fix "base64" encoding problem with PHOTO attribute.
	Fixes: NB#98290.

	* addressbook/libebook-dbus/e-contact.c (photo_getter())

2009-02-06  Robert Peto  <robert.peto@maemo.org>

	Fix error handling in e_book_add_contacts().

	* addressbook/libebook-dbus/e-book.c: see above.
	* addressbook/libedata-book-dbus/e-data-book.c
	 (e_data_book_respond_create_contacts()): Use g_strfreev() for
	allocated char **

2009-02-06  Robert Peto  <robert.peto@maemo.org>

	Fix running id issue in addressbook's file backend.

	* addressbook/backends/file/e-book-backend-file.c
	 (insert_contact())

2009-02-02  Robert Peto  <robert.peto@maemo.org>

	Fix indexing problem in addressbook's file backend. (When starting
	BookView contacts without name doesn't get back.)

	* addressbook/backends/file/e-book-backend-file.c
	* addressbook/backends/file/e-book-backend-file-index.c

2009-01-22  Robert Peto  <robert.peto@maemo.org>

	Fix loading of preinstalled vcards in addressbook's file backend.

	* addressbook/backends/file/e-book-backend-file.c
	 (e_book_backend_file_load_source()): See above.

2009-01-22  Robert Peto  <robert.peto@maemo.org>

	New util functions for prevent duplications in addressbook.

	* addressbook/libebook-dbus/e-book-util.c,
	  addressbook/libebook-dbus/e-book-util.h:
	 (e_book_util_remove_duplicates(),
	  e_book_util_remove_duplicates_using_book()): See above

2009-01-21  Robert Peto  <robert.peto@maemo.org>

	New API functions for persist / inline data in addressbook. (Currently only
	for PHOTO and LOGO properties.)

	* addressbook/libebook-dbus/e-contact.c
	 (e_contact_photo_convert_to_inlined(),
	  e_contact_photo_convert_to_uri(),
	  e_contact_inline_data(), e_contact_persist_data()): See above.
	* configure.in: linking addressbook to gio.

2009-01-16  Robert Peto  <robert.peto@maemo.org>

	Use EFlag in threaded operations of EBookBackend class to prevent them
	running before OPEN has finished.

	* addressbook/libedata-book-dbus/e-book-backend.c
	 (e_book_backend_open(), e_book_backend_create_contact(),
	  e_book_backend_create_contacts(), e_book_backend_remove_contacts(),
	  e_book_backend_modify_contact(), e_book_backend_modify_contacts(),
	  e_book_backend_get_contact(), e_book_backend_get_contact_list(),
	  e_book_backend_get_changes(), e_book_backend_authenticate_user(),
	  e_book_backend_init(), e_book_backend_dispose())

